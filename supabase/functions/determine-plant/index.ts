// Follow this setup guide to integrate the Deno language server with your editor:
// https://deno.land/manual/getting_started/setup_your_environment
// This enables autocomplete, go to definition, etc.

const plantList = `African rice
African sheepbush
African violet
Alder
Aleppo pine
Algerian Oak
Almond
Aloe vera
Amaranth
Ambrosia
American cress
American dogwood
American nightshade
American white hellebore
American winterberry
Amy root
Angel trumpet
Angel trumpet
Annual sow thistle
Apache pine
Appalachian tea
Apple
Apricot
Arfaj
Arizona sycamore
Arrowwood
Ash
Ash-leaved maple
Asian rice
Atlas pistachio
Austrian pine
Azolla
Baby rose
Bamboo
Banana
Bank cress
Baobab
Bastard pellitory
Bay
Bay laurel
Bean
Bear corn
Bearberry
Beech
Belle Isle cress
Bermuda cress
Bermuda grass
Big hellebore
Bindweed
Birch
Bird of paradise
Bird's nest
Bird's nest plant
Bitter nightshade
Bittercress
Bittersweet
Bitterweed
Black alder
Black ash
Black birch
Black cap
Black cherry
Black hellebore
Black maple
Black nightshade
Black pine
Black raspberry
Black-eyed Susan
Black-weed
Blackberry
Blackhaw
Blackhaw viburnum
Blue Atlas cedar
Blue ash
Blue bindweed
Blue oak
Blue-of-the-heavens
Bluebell
Blueberry
Blueberry cornel
Blunt-leaved Milkweed
Bola verde
Bolean birch
Bosnian pine
Boston fern or sword fern
Bow-wood
Box
Boxelder
Boxwood
Bracken's Brown Beauty magnolia
Brier
Brilliant coneflower
Bristly dewberry
Bristly groundberry
Brittlebush
Broadleaf
Brown Betty
Brown daisy
Brown-eyed susan
Buckeye
Buckeye (California buckeye)
Buffalo weed
Bugle
Bulbous cress
Bull nettle
Bur oak
Butterfly flower
Butterfly weed
Cabbage
Cabinet cherry
California Black Oak Quercus kelloggii
California bay
California bay
California buckeye
California sycamore
California thistle
California walnut
Canada root
Canada thistle
Canary Island pine
Cancer jalap
Cane ash
Canoe birch
Canyon Live Oak Quercus chrysolepis
Carolina azolla
Carolina horse nettle
Carrot
Carrot weed
Cart track plant
Catalina ironwood
Cedar
Chalk milkwort
Champion oak
Charlock
Cherry
Cherry birch
Chestnut
Chigger flower
Chinese pistache
Chinese red pine
Chir pine
Chittick
Christmas fern
Chrysanthemum
Cinnamon
Climbing nightshade
Clove
Clover
Clumpfoot cabbage
Coakum
Coast live oak
Coast polypody
Coconut
Coffee plant
Colic weed
Collard
Columbine
Colwort
Comfrey
Common alder
Common daisy, daisy
Common fig
Common milkweed
Common onion
Common plantain
Common ragweed
Common ragwort
Common serviceberry
Common tansy
Common yarrow
Coneflower
Cork oak
Corn sow thistle
Corn speedwell
Corn thistle
Cornel
Cornelian tree
Corydalis
Cotton plant
Coyote willow
Creek maple
Creeping thistle
Creeping yellowcress
Cress
Crow's nest
Crow's toes
Crowfoot
Cucumber
Cursed thistle
Cutleaf coneflower
Cutleaf maple
Cutleaf toothwort
Daisy
Damask violet
Dame's gilliflower
Dame's rocket
Dame's violet
Deadly nightshade
Deadnettle
Deciduous holly
Deodar cedar
Desert Rose
Devil's bite
Devil's darning needle
Devil's nose
Devil's plague
Dewberry
Dindle
Dog's-tooth-violet or dogtooth violet
Dogwood
Downy serviceberry
Drumstick
Duck retten
Durian
Durian kura kura
Durian munjit
Durian pulu
Duscle
Dwarf wild rose
Dye-leaves
Dyer's oak
Early wintercress
Earth gall
Easter orchid
Easter orchid (Cattleya schroederae)
Eastern black oak
Eastern coneflower
Eastern redbud
Elderberry
Elegant lupine
Elephant apple
English bull's eye
English oak
Eucalyptus
European ash
European flax
European holly
European pellitory
European weeping birch
European white birch
European white hellebore
Evergreen huckleberry
Evergreen huckleberry
Evergreen winterberry
Extinguisher moss
Eytelia
Fair-maid-of-France
Fairall's honeysuckle
Fairymoss Azolla caroliniana
False alder
False box
False boxwood
False hellebore
False pineapple
Fellenwort
Fellenwort (Solanum dulcamara)
Felonwood
Felonwort
Fennel
Fern-leaf Corydalis
Fernleaf yarrow
Ferns
Feverbush
Feverfew
Field forget-me-not
Field sow thistle
Fig
Flax
Florida dogwood
Flowering Dogwood (Cornus florida)
Flowering dogwood
Fluxroot
Foxglove
Foxtail amaranth
Fumewort
Galaxy magnolia
Gallberry
Garden nightshade
Garget
Garlic
Garlic mustard
Garlic root
Germander speedwell
Gewa (Bangladesh)
Giant onion
Giant ragweed
Gilliflower
Gloriosa daisy
Golden Jerusalem
Golden buttons
Golden chain
Golden chain (Laburnum)
Golden corydalis
Golden garlic
Golden poppy (Eschscholzia californica)
Goldenglow
Goodding willow
Goose tongue
Gordaldo
Grapefruit
Grapevine
Grass
Gray alder
Gray birch
Great ragweed
Green ash
Green berry nightshade
Green honeysuckle
Green thistle
Green-headed Coneflower
Groundberry
Gutweed
Hairy bittercress
Haldi
Hard thistle
Hare's colwort
Hare's thistle
Harlequin
Hay fever weed
Healing blade
Heath-leaved honeysuckle
Hedge plant
Hellebore
Hellebore (Helleborus orientalis)
Hemlock 
Hemp
Hemp dogbane
Hen plant
Henbit deadnettle
Henry's pine
Herb barbara
Hispid swamp blackberry
Hoary ragwort
Hogweed
Holly
Holly-leaved honeysuckle
Honesty
Honey flower
Honey mesquite
Horse cane
Horse nettle
Horseradish
Horsetail milkweed
Hound's berry
Houseleek
Huangshan pine
Huckleberry
Hydrangea
Indian arrowwood
Indian hemp
Indian hemp
Indian paintbrush
Indian poke
Indian posy
Inkberry
Inkberry holly
Ironwood
Island oak
Isle of Man cabbage
Itchweed
Ivy
Ivy (Hedera)
Jack-by-the-hedge
Jack-in-the-bush
Jane magnolia
Japanese flowering dogwood
Japanese red pine
Jasmine
Jasmine (Jasminum officinale)
Jewel orchid
Jointed rush
Judas-tree
Jugflower
Juneberry
Juniper
Kay Parris magnolia
Keek
Khasi pine
Kimberly queen fern
King fern
Kinnikinnik
Kittentail
Knotweed (Japanese)
Korean rock fern
Kousa
Kousa dogwood
Kudzu
Kudzu (Pueraria montana)
Kumarahou
Lace Aloe
Lace fern
Laceflower
Lady's mantle
Lady's smock
Lamb's cress
Lamb's foot
Land cress
Latanier palm
Laurel magnolia
Lavender
Lavender (Lavandula angustifolia)
Leatherleaf viburnum
Leek
Lemon
Leopard lily
Lettuce
Lilac
Lily leek
Lily of the Nile
Little Gem magnolia
Little sunflower
Loblolly pine
Lone fleabane
Love vine
Love-lies-bleeding
Low rose
Luchu pine
Lupin
Magnolia
Mahogany birch
Maize
Mango
Many-flowered honeysuckle
Maple
Maple ash
Maple ash
Maritime pine
Marsh ragwort
Masson's pine
Meadow cabbage
Meadow holly
Merkus pine
Mesquite
Mexican pistache
Milfoil
Milk thistle
Milkweed
Milky tassel
Mirbeck's oak
Moonglow magnolia
Moose maple
Moosewood
Morelle verte
Mosquito fern
Mosquito plant
Mossycup white oak
Mother-of-the-evening
Mount Connor wattle
Mountain devil
Mountain mahogany
Mountain pine
Mulberry
Multiflora rose
Multiflora rose (Rosa multiflora)
Native fuchsia
Native fuchsia (Epacris longiflora)
Necklace fern
Neem
Nettle
New Zealand flax
Night scented gilliflower
Night-blooming cactus
Nightshade
Nodding onion
Nodding thistle
Nodding wakerobin
Northern moonwort
Northern red oak
Nosebleed
Oak tree
Obedient Plant
Olive
Onion
Orange
Orange coneflower
Orange milkweed
Orange swallow-wort
Orange swallow-wort
Orange-root
Osage
Osage orange
Osier
Oxford ragwort
Pacific dogwood
Pale corydalis
Paper birch
Parsley
Parsnip
Pawpaw 
Pea
Peach
Peanut
Pear
Pedunculate oak
Pellitory
Pennsylvania blackberry
Penny hedge
Pepper root
Perennial thistle
Persian turpentine tree
Petty morel
Petty morel (Solanum nigrum)
Petty spurge
Pigeon berry
Pin oak
Pine
Pineapple
Pineapple
Pink corydalis
Pistachio
Pistachio
Plane (European sycamore)
Plantain
Pleurisy root
Poached egg plant
Pocan bush
Poison ivy
Poisonberry
Poisonflower
Poke
Pokeroot
Pokeweed
Polecat weed
Polkweed
Poor Annie
Poor man's mustard
Poorland daisy
Poplar
Poppy
Possumhaw
Potato
Prairie rose
Prickly honeysuckle
Prickly thistle
Primrose
Purple raspberry
Purple-flowered Toothwort
Queen Anne's lace
Queen's gilliflower
Quercitron
Radical weed
Ragweed
Ragwort
Rambler rose
Rantipole
Rapeseed
Raspberry
Red ash
Red birch
Red deadnettle
Red durian
Red ink plant
Red mulberry
Red oak
Red osier
Red pine
Red river maple
Red willow
Redbrush
Redbud
Redweed
Redwood sorrel
Rheumatism root
Rhubarb
Ribwort
Rice
River ash
River birch
River maple
Roadweed
Rock harlequin
Rocket
Rocketcress
Rogue's gilliflower
Roman wormwood
Rose
Rose milkweed
Rose willow
Rosemary
Round-leaf honeysuckle
Royal Star magnolia
Rum cherry
Running swamp blackberry
Rye
Saffron crocus
Sand brier
Sanguinary
Saskatoon
Sauce-alone
Scarlet berry
Scarlet oak
Scoke
Scotch cap
Scots pine
Scrambled eggs
Screwbean mesquite
Scrub oak
Scurvy cress
Scurvy grass
Sea plantain
Serendipity Ruby magnolia
Serviceberry
Sessile oak
Shadblow
Shadblow serviceberry
Shadbush
Sharp-fringed sow Thistle
Shrubby mayweed
Sikang pine
Silkweed
Silky cornel
Silky dogwood
Silky swallow-wort
Silky swallow-wort
Silver birch
Silver maple
Silver ragwort
Silverleaf maple
Skunk cabbage
Skunkweed
Small-flowered Thistle
Snakeberry
Sneezeweed
Sneezewort
Sneezewort yarrow
Snowdrop
Snowdrop (Galanthus)
Soft maple
Soldier's woundwort
Sorrel
Southern magnolia
Southern magnolia (Magnolia grandiflora)
Spanish oak
Speckled alder
Speedwell
Spice birch
Spikenard
Spiny sow thistle
Spiny-leaved sow Thistle
Spoolwood
Spotted deadnettle
Spotted oak
Spring cress
Squaw bush
Stag bush
Stammerwort
Star-of-Persia
Stellar Ruby magnolia
Stickweed
Stone pine
Strawberry
Strawberry tree
Strawberry tree 'Marina'
Striped maple
Sugar maple
Sugarcane
Sugarplum
Summer lilac
Sundari (Bangladesh)
Sunflower
Swallow-wort
Swallow-wort
Swamp Spanish oak
Swamp ash
Swamp cabbage
Swamp dewberry
Swamp dogwood
Swamp hellebore
Swamp holly
Swamp maple
Swamp milkweed
Swamp oak
Swamp silkweed
Swamp white oak
Sweet birch
Sweet orange
Sweet orange (Citrus Ã— sinensis)
Sweet potato
Sweet potato vine
Sweet rocket
Sweetbay magnolia
Swine thistle
Swinies
Swiss Cheese Plant
Sword ferns
Sycamore
Sycamore (American)
Sycamore (Arizona)
Sycamore (California)
Taiwan red pine
Tall ambrosia
Tall coneflower
Tansy
Tassel weed
Tea
Tenasserim pine
Terebinth
Thimbleberry
Thimbleweed
Thin-leaved Coneflower
Thistle
Thousand-leaf
Thousand-seal
Three-leaved Coneflower
Thyme
Tickleweed
Tobacco plant
Tobacco plant (Nicotiana glauca)
Tomato
Toothwort
Touch-me-not
Trailing bittersweet
Trailing nightshade
Trailing red huckleberry
Trailing violet nightshade
Traveller's joy
Tread-softly
Tree onion
Tree sow thistle
Tree tobacco
Trillium
Tropical pine
Tuber-root
Tulip
Tulsi
Turkish pine
Umbrella palm
Umbrella papyrus
Upland cress
Valley oak
Vanilla orchid
Varnish tree
Velvet bean
Viburnum
Viola species
Violet
Violet bloom
Viper's grass
Virgin's bower
Virginia silkweed
Virginia virgin's bower
Virginia winterberry
Voodoo lily
Voodoo lily (Dracunculus vulgaris)
Wall speedwell
Walnut
Water Fern
Water ash
Water birch
Water fern
Water maple
Waterlilly Star magnolia
Wattle
Way thistle
Waybread
Weed (Marijuana)
Weeping birch
Western redbud
Western redbud
Western sword fern
Western trillium
Western wake robin
Wheat
Whiskey cherry
White Indian hemp
White alder
White ash
White birch
White cornel
White hellebore
White man's foot
White maple
White mulberry
White oak
White tansy
White trillium
White-root
Whorled milkweed
Wild black cherry
Wild carrot
Wild cherry
Wild cotton
Wild garlic
Wild honeysuckle
Wild hops
Wild onion
Wild orange
Wild pellitory
Wild rose
Wild tansy
Willow
Windroot
Wineberry
Winter gilliflower
Winter rocket
Winterberry
Winterberry holly
Wintercress
Woodbine
Woody nightshade
Woolly morning glory
Woolly morning glory (Argyreia nervosa)
Woolly yarrow
Wormwood
Wound rocket
Yam
Yarrow
Yellow birch
Yellow coneflower
Yellow coneflower (Echinacea paradoxa)
Yellow corydalis
Yellow daisy
Yellow fieldcress
Yellow fumewort
Yellow harlequin
Yellow milkweed
Yellow ox-eye daisy
Yellow rocket
Yellowbark oak
Yellowwood
Yunnan camellia
Yunnan pine
Zebrawood
Zebrawood
Zebrawood (Brachystegia spiciformis)
Zedoary
`

import {GoogleGenerativeAI} from "npm:@google/generative-ai";
import {createClient} from 'https://esm.sh/@supabase/supabase-js@2.7.1'

console.log("Hello from Functions!")

export const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

const GeminiApiKey = Deno.env.get("GEMINI_API_KEY")!;

const genAI = new GoogleGenerativeAI(GeminiApiKey);

const model = genAI.getGenerativeModel({model: "gemini-1.5-flash"});

// @ts-ignore
Deno.serve(async (req: Request) => {
    // This is needed if you're planning to invoke your function from a browser.
    if (req.method === 'OPTIONS') {
        return new Response('ok', {headers: corsHeaders})
    }

    console.log("REQUEST: ", req);

    try {
        let data = await req.json();

        console.log("DATA: ", data);

        let imageBase64 = data.ImageBase64;

        // strip all parts of the image data except the base64 string
        imageBase64 = imageBase64.replace(/^data:image\/\w+;base64,/, "");

        const image = {
            inlineData: {
                data: imageBase64,
                mimeType: "image/png",
            },
        };

        const prompt = "What type of plant is in this image? Respond only with an item listed below or undefined; never respond with 'tree'. If it is unrecognizable state unrecognizable. Do not include a period at the end of your response. If the plant is not real or the image is a photo of a screen state unrecognizable" + plantList;
        const result = await model.generateContent([prompt, image]);

        console.log(result.response.text())

        if (result == "unrecognizable") {
            console.log("supressing");

            return new Response(JSON.stringify({data: result.response.text()}), {
                headers: {...corsHeaders, 'Content-Type': 'application/json'},
                status: 200,
            })
        }

        const supabaseClient = createClient(
            // Supabase API URL - env var exported by default.
            Deno.env.get('SUPABASE_URL') ?? '',
            // Supabase API ANON KEY - env var exported by default.
            Deno.env.get('SUPABASE_ANON_KEY') ?? '',
            // Create client with Auth context of the user that called the function.
            // This way your row-level-security (RLS) policies are applied.
            {
                global: {
                    headers: {Authorization: req.headers.get('Authorization')!},
                },
            }
        )

        console.log("SUPABASE CLIENT: ", supabaseClient);

        const token = req.headers.get('Authorization').replace('Bearer ', '')

        // Now we can get the session or user object
        const {
            data: {user},
        } = await supabaseClient.auth.getUser(token)

        // get already existing user data
        let {data: _userData, error: plantsError} = await supabaseClient.from('Plants').select('data').eq('user_id', user?.id)

        // if the user has no data, create a new object
        if (!_userData) {
            await supabaseClient.from('Plants').insert([
                {
                    user_id: user?.id,
                    data: {plants: []},
                },
            ])

            _userData = {plants: [], images: []}
        }

        if (_userData.plants == null) {
            _userData.plants = []
            _userData.images = []
        }

        // add plant to the user's data
        _userData!.plants = [..._userData.plants, result.response.text()]

        _userData!.images = [..._userData.images, imageBase64]


        let id = user?.id;

        if (!id) {
            // gen random id
            id = Math.random() * 1000000000000000000;

            // force int
            id = Math.floor(id);
        }

        console.log("USER DATA: ", _userData);
        console.log("USER ID: ", id);

        // write the plant to the database
        const {_data, error} = await supabaseClient.from('Plants').insert([
            {
                user_id: id,
                data: _userData,
            },
        ])


        return new Response(JSON.stringify({data: result.response.text()}), {
            headers: {...corsHeaders, 'Content-Type': 'application/json'},
            status: 200,
        })
    } catch (error) {
        return new Response(JSON.stringify({error: error.message}), {
            headers: {...corsHeaders, 'Content-Type': 'application/json'},
            status: 400,
        })
    }
})

/* To invoke locally:

  1. Run `supabase start` (see: https://supabase.com/docs/reference/cli/supabase-start)
  2. Make an HTTP request:

  curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/hello-world' \
    --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0' \
    --header 'Content-Type: application/json' \
    --data '{"name":"Functions"}'

*/
